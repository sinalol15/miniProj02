<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="org.kosa.hello.member.MmemberMapper1">
    <sql id="search">
        <where>
            <if test="searchKey != null and searchKey != ''">
                mname like concat('%', #{searchKey}, '%')
            </if>
        </where>
    </sql>
    
	<select id="login" resultType="org.kosa.hello.entity.MmemberVO1">
		select 
			*  
		from tb_member   
		where mid = #{mid}
	</select>
	
	<select id="getList" resultType="org.kosa.hello.entity.MmemberVO1">
	    select 
			mid, mname, mage, memail 
		from tb_member
		<include refid="search"/>
		order by mid desc limit #{skip}, #{size}
	</select>
	
	<!-- 	    SELECT *
	    FROM (
	        SELECT mid, mname, mage, memail,
	               ROW_NUMBER() OVER (ORDER BY mid DESC) AS rn
	        FROM tb_member
	        <include refid="search"/>
	    )
	    WHERE rn BETWEEN #{skip} + 1 AND #{skip} + #{size}
	    ORDER BY rn -->
	
	<select id="getTotalCount" resultType="int">
		select
			count(*)
		from tb_member
		<include refid="search"/>
	</select>
	
	<select id="read" resultType="org.kosa.hello.entity.MmemberVO1">
		select * from tb_member where mid = #{mid}
	</select>
	
	<delete id="delete">
		delete from tb_member where mid = #{mid}
	</delete>
	
	<update id="update">
		update tb_member set mname=#{mname}, mpassword=#{mpassword}, mage=#{mage}, memail=#{memail} where mid=#{mid}
	</update>
	
	<insert id="insert">
		insert into tb_member (mid, mname, mpassword, mage, memail, mgender) values (#{mid},#{mname}, #{mpassword}, #{mage},#{memail},#{mgender})
	</insert>
	
	<update id="updateUUID">
		update tb_member set muuid=#{muuid} where mid=#{mid}
	</update>
	
	<select id="hobbies" resultType="org.kosa.hello.entity.MhobbyVO1">
		select * from tb_habbit order by hnumber
	</select>
	
	<select id="hobbyFoundCheck" resultType="org.kosa.hello.entity.MhobbyVO1">
		select h.*,	(SELECT 'checked' FROM tb_mhabbit m WHERE m.mhid=#{mid} AND mhnumber = h.HNUMBER) checked from TB_HABBIT h
	</select>
	
	<insert id="hobbyFoundInsert">
		insert into tb_mhabbit values (#{mid}, #{mhabbit})
	</insert>
	
	<select id="hobbiesName" resultType="org.kosa.hello.entity.MmemberVO1">
		select hname from tb_mhabbit JOIN TB_MEMBER ON mid = mhid JOIN TB_HABBIT ON hnumber = mhnumber WHERE mid = #{mid} order by mhid
	</select>
	
	<update id="updateMemberLastLogin">
		update tb_member set 
			member_last_login_time = now()
		where mid = #{mid}
	</update>
	
	<update id="loginCountInc">
		update tb_member set 
			member_login_count = member_login_count + 1
			<choose>
				<when test="member_login_count > 5">
					, member_account_locked = 'Y'
				</when>
				<otherwise>
					, member_account_locked = 'N'
				</otherwise>
			</choose>
		where mid = #{mid}
	</update>

	<update id="loginCountClear">
		update tb_member set 
			 member_login_count = 0
			,member_account_locked = 'N'
		where mid = #{mid}
	</update>
</mapper>